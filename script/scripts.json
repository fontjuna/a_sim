{
    "일반매수": {
        "script": "# 스크립트명 : 일반매수 v20250917.002800\n\nreason = 일반매도(logoff=True)\nif reason:\n    echo(f'[False] ({code} {name}) / {reason}')\n    ret(False)\n\nret(True)",
        "desc": "[일반매수]\n1. 일반매도 스크립트 조건에 해당하지 않고,"
    },
    "일반매도": {
        "script": "# 스크립트명 : 일반매도 v20250917.002800\n\n\"\"\"\n<키움 검색식에 구현해야 할 조건들>\n- 없음.\n\n<이 스크립트에서 적용한 조건들>\n- 작성 중\n\"\"\"\n\ndm = ChartManager(code, 'dy')\nm3 = ChartManager(code, 'mi', 3)\nlogoff = is_args('logoff', False)\n\n최고종가, 당일봉수 = m3.get_close_tops(k=1, w=128, m=128, n=1)\n\nif len(최고종가) == 0: pos = 1\nelse: pos = 최고종가[0]\n\no, h, l, c, v, ma = m3.o, m3.h, m3.l, m3.c, m3.v, m3.ma\n# 봉 특성 별칭 (필요 시 즉시 호출)\ntop, bottom = m3.body_top, m3.body_bottom\nup_tail, down_tail = m3.up_tail, m3.down_tail\nbody = m3.body\nbody_pct = m3.body_pct\nlength_pct = m3.length_pct\nup_tail_pct = m3.up_tail_pct\ndown_tail_pct = m3.down_tail_pct\nred = m3.red\nblue = m3.blue\n\nmsg = ''\nm3._ensure_data_cache()\nwith m3.suspend_ensure():\n    # 최상위: 매우 가벼운 판정들\n    if hoga(dm.c(1), 99) <= dm.c(0):\n        msg = f'상한가'\n    elif percent(c(0), h(0)) < -5.0:\n        msg = f'현재봉 고가 대비 -5% 이하 하락 중'\n    elif ma(5, 1) > ma(5, 0):\n        msg = f'현재 5이평 하락 중'\n    elif ma(10, 0) > ma(5, 0):\n        msg = f'현재 5, 10이평 역전 상태'\n    elif c(1) < ma(10, 1):\n        msg = f'전봉 종가, 10이평 역전 상태'\n    else:\n        # 현재봉으로 판단\n        if c(1) < o(0):\n            if percent(o(0), c(1)) > 1.0 and c(1) > c(0):\n                msg = f'1% 이상 갭 상승 시작 후 전봉 종가 이하로 하락'\n        elif pos == 1 and o(0) < c(1) and c(0) < o(0):\n            msg = f'현재봉 갭 하락 시작 음봉'\n\n        if not msg:\n            idx, candle = m3.get_highest_volume(m=10, n=1)\n            if candle['현재가'] > candle['시가'] >= candle['저가'] > c():\n                msg = f'10봉중 최고거래량봉 아래로 이탈'\n\n        if not msg and c() <= h(1):\n            if down_tail_pct(1) >= 1.0 and (o(1) == c(1) or down_tail(1) > body(1) * 5) and up_tail(1) < down_tail(1) * 0.2:\n                msg = f'교수형 캔들의 고가 갱신 못함'\n\n        if not msg and blue(0) and all([red(3), red(2), red(1)]) and c(3) < c(2) < c(1):\n            min_body = hoga(o(1), 5) - o(1)\n            if not (body(1) < min_body or body(3) < min_body):\n                if body(3) > body(2) > body(1) and c(1) - (c(1) - o(1)) / 2 > c():\n                    msg = f'상승 체력 소진으로 3연속 몸통이 작아 지면서 전봉 중간 이하로 하락'\n\n                elif body(1) > body(2) > body(3) and c(1) - (c(1) - o(1)) / 3 > c():\n                    msg = f'3연속 몸통이 커졌으나 체력 소진으로 고가 돌파 못한 전봉 1/3 이하로 하락'\n\n        # 이하 전봉으로 판단\n        if not msg and (h(2) > h(1) and bottom(1) >= top(2)):\n            if up_tail(1) > down_tail(1):\n                msg = f'전봉 고가 갱신 불발후 위꼬리 내부에서 마감'\n\n        if not msg and up_tail_pct(1) >= 2.0:\n            if o(1) == c(1) or up_tail(1) > body(1) * 3:\n                msg = f'전봉 윗꼬리 2%이상 유성형 패턴으로 급락'\n\n        # 음봉 패턴군 (blue)\n        if not msg and (c(1) < o(1)):\n            if up_tail_pct(1) >= 1.0:\n                if top(2) < bottom(1):\n                    msg = f'전봉 `윗꼬리 1%이상 음봉 갭 상승 마감'\n                elif (o(1) == c(1) or up_tail(1) >= body(1) * 2.5) and up_tail(1) * 0.2 > down_tail(1):\n                    msg = f'전봉 윗꼬리 1%이상 유성형 음봉'\n                elif body(1) >= up_tail(1) * 0.8:\n                    msg = f'전봉 윗꼬리 1%이상 떨어지는 칼날'\n            elif up_tail_pct(2) >= 1.0 and up_tail(2) > down_tail(2):\n                if h(2) >= h(1) and (h(1) - c(1)) / o(1) > 0.01:\n                    msg = f'전봉 윗꼬리 1%이상 연속 고가 저항'\n            elif (c(2) >= o(2)):\n                if body_pct(2) > 1:\n                    if top(2) >= top(1) and bottom(2) < bottom(1) and length_pct(1) < 1:\n                        msg = f'전봉 하락 잉태형 패턴'\n                    elif top(2) <= top(1) and bottom(2) > bottom(1):\n                        msg = f'전봉 하락 장악형 패턴'\n            elif c(3) >= o(3) and c(3) > c(1):\n                if body_pct(3) > 2 and v(3) > v(2) * 2:\n                    if m3.is_doji(0.2, 2) and c(1) < o(1) and v(3) > v(1) * 2:\n                        msg = f'하락 전환 석별형 패턴'\n\n        # 양봉 패턴군 (red)\n        if not msg and c(2) >= o(2):\n            if up_tail_pct(2) >= 1.5:\n                up = up_tail(2)\n                if c(2) > c(1) and (o(2) == c(2) or (up >= body(2) * 3 and up * 0.2 > down_tail(2))):\n                    msg = f'전전봉 윗꼬리 1.5% 이상 몸통의 3배 유성형 양봉'\n            elif body_pct(2) > 1:\n                if top(2) >= top(1) and bottom(2) < bottom(1) and length_pct(1) < 0.5:\n                    msg = f'전봉 하락 잉태형 패턴'\n\n        # 최고종가 봉 패턴군 (pos)\n        if not msg and pos > 2:\n            if h(pos) > h(1) and bottom(1) >= top(pos):\n                msg = f'전봉 최고종가봉 고가 갱신 불발후 위꼬리 내부에서 마감'\n            elif (c(pos) >= o(pos)) and body_pct(pos) > 1:\n                if top(pos) <= top(1) and bottom(pos) > bottom(1):\n                    msg = f'전봉 최고종가 하락 장악형 패턴'\n        #elif not msg and pos >= 1:\n        #    if (c(pos) - o(pos)) / 2 > c() and h(pos) > h():\n        #        msg = f'전봉 최고종가봉 고가 갱신 불발후 퇴고 종가봉 몸통 중간 이하로 하락'\n\nif msg: \n    if logoff:\n        ret(msg)\n    else:\n        echo(f'[{True}] ({code} {name}) 현재가={dm.c()} / {msg}')\n        ret(True)\nret(False)",
        "desc": "[일반매도]\n1. 상한가 이거나,\n2. 기준봉 기준가 이하이거나,\n3. 현재봉 기준 3분봉 5이평이 하락전환 하거나,\n4. 현재봉 기준 3분봉 5이평이 10이평 이하 이거나,\n5. 현재가가 10이평 이하 이거나,\n6. 전봉이 유성형 캔들이거나,\n7. 현재봉이 긴 윗꼬리달고 최고종가 이하로 하락시 매도"
    },
    "거래량매수": {
        "script": "# 스크립트명 : 거래량매수 v20250920.170345\n\n\"\"\"\n<키움 검색식에 구현해야 할 조건들>\n1. 거래대금 상위 100종목 또는 거래량 상위 100종목 이고,\n2. 주가범위 전일 기준 2,000원 ~ 499,900원 이고,\n3. 현재가 기준 시가 총액 500억원 ~ 5조원 이고,\n4. 전일 최고가 대비 종가 하락율 5%이내이거나 전일 최고가 대비 종가 하락율 8~5% 이면서 현재가가 전일 최고가를 넘어서야 하고\n5. 일봉상 현재가는 20이평의 1.5배 이내 이면서 상승률 20% 이내이고,\n6. 일봉상 1봉전 20이평이 상승 중이고, 현재 종가가 3, 20이평 이상이고,\n7. 3분봉상 현재가가 5, 10, 20이평 이상이고, 현재봉 기준 5, 15이평이 상승 중이고,\n8. 일봉상 60일 최고 거래량 대비 3분봉 거래량이 0.78%이상이고,\n9. 3분봉상 1봉전 127봉중 최고거래량의 34% 이상\n\n<이 스크립트에서 구현 할 조건들>\n0. 매수전략과 AND로 연결\n1. 이하 Cursor AI가 코드 분석 후 작성 할 것 (Cursor AI는 여길 읽는 즉시 작성 또는 수정 할 것)\n\"\"\"\n\nm1 = ChartManager(code, 'mi', 1)\nm3 = ChartManager(code, 'mi', 3)\ndm = ChartManager(code, 'dy')\n\n# 기본 값 접근자 별칭\no, h, l, c, v, ma = m3.o, m3.h, m3.l, m3.c, m3.v, m3.ma\nup_tail, up_tail_pct = m3.up_tail, m3.up_tail_pct\ndown_tail, down_tail_pct = m3.down_tail, m3.down_tail_pct\nbody, body_pct = m3.body, m3.body_pct\nlength, length_pct = m3.length, m3.length_pct\nbottom, top = m3.body_bottom, m3.body_top\nblue, red = m3.blue, m3.red\n# mas = [20, 15, 10, 7, 5, 3]\nmas = [21, 15, 12, 6]\n\n# 같은 봉에서 매도한 경우 매수 안함 ========================================================================\nlast_sell = get_trade_state(code, 'sell')\nif last_sell and last_sell.get('bar_time') == m3.bar_time():\n    echo(f'△ {code} {name} 현재가={c()} / 현재봉에서 이미 매도함 (매도가: {last_sell.get(\"sell_price\")}, 이유: {last_sell.get(\"reason\")})')\n    ret(False)\n\nmsg = ''\n\n# 일봉 조건 찾기 ========================================================================\ndm._ensure_data_cache()\nwith dm.suspend_ensure():\n    v_dic = dm.get_volume_stats(m=60, n=0)\n    if v_dic['max'] < v_dic['avg'] * 3.0:\n        msg = f\"최고거래량({v_dic['max']/10000:.0f}만)이 평균({v_dic['avg']/10000:.0f}만)의 3.0배를 넘지 않음\"\n\n    # 조건 검색식 대신 처리 한 것\n    if not msg:\n        if percent(dm.c(), dm.c(1)) > 20.0:\n            msg = f'주가가 20% 이상 상승 중이면 매수 안함'\n\n    if not msg:\n        fall_pct = percent(dm.h(1), dm.c(1))\n        if fall_pct > 8.0:\n            msg = f'전일 고가 대비 종가 하락율 8% 이상'\n        elif fall_pct > 5.0:\n            if c() < dm.h(1):\n                msg = f'전일 고가 대비 종가 하락율 5% 이상이고 그 고가를 넘지 못함'\n\n    if not msg:\n        dm_today_bars, dm_rise, dm_maru = dm.get_rising_state([20, 5], 0)\n        limit_rate = 30.0\n        if dm_maru['rise_rate'] > limit_rate:\n            if dm.ma(3, 1) > dm.ma(3):\n                msg = f'일봉상 {limit_rate}% 이상 상승중 3이평 하락시 매수 안함'\n            elif dm.ma(3) > c():\n                msg = f'일봉상 {limit_rate}% 이상 상승중 3이평 이하에서서 매수 안함'\n            \n    if not msg:\n        # 일봉상 긴 윗꼬리가 달린 봉이 많이 나타나는 종목은 털리기 쉽다.\n        cnt = 0\n        limit = 3\n        for i in range(0, 10):\n            if dm.body_pct(i) > 2.0 and dm.up_tail(i) > dm.body(i): cnt += 1\n            if cnt >= limit: break\n\n        if cnt >= limit:\n            msg = f'최근 10개봉 중 몸통보다 긴 윗꼬리 봉 {cnt}개'\n\n    if msg:\n        echo(f\"△ {code} {name} 현재가={dm.c()} / {msg}\")\n        ret(False)\n\n# 분봉 조건 찾기 ========================================================================\nm1._ensure_data_cache()\nwith m1.suspend_ensure():\n    # 현재봉 판단\n    if not msg:\n        if m1.blue(): \n            msg = f'1분봉이 음봉이면 매수 안함'\n        elif m1.is_shooting_star(2.0, 4.0, 1.0, n=0):\n            msg = f'1분봉이 유성형 패턴이면 매수 안 함'\n    \n    # 전봉으로 판단\n    if not msg:\n        if m1.body_top(2) <= m1.o(1) and m1.body_bottom(2) > m1.c(1):\n            msg = f'1분봉 하락 장악형 패턴 다음 매수 안 함'\n        elif m1.is_shooting_star(2.0, 4.0, 1.0, n=1):\n            msg = f'1분봉 유성형 패턴 다음 매수 안 함'\n\n    if msg:\n        echo(f\"△ {code} {name} 현재가={m1.c()} / {msg}\")\n        ret(False)\n\nm3._ensure_data_cache()\nwith m3.suspend_ensure():\n    # 조건 검색식 대신 처리 한 것\n    if not msg:\n        if ma(6) > c(): msg = f'6'\n        if ma(15) > c(): msg = f'15' if not msg else msg+', 15'\n        msg = f'{msg} 이평 이하에서 매수 안함' if msg else ''\n\n    if not msg:\n        if ma(6, 1) > ma(6) or ma(15, 1) > ma(15):\n            msg = f'6 또는 15 이평 하락 중이면 매수 안함'\n\n    if msg:\n        echo(f\"△ {code} {name} 현재가={c()} / {msg}\")\n        ret(False)\n\n    # 여기 부터 스크립트\n    today_bars, rise, maru = m3.get_rising_state(mas, 0)\n    \n    try:\n        # 빈 딕셔너리 처리 (확정 봉 없음)\n        if not rise or not maru:\n            if today_bars == 1 and all(c() >= ma(mp) for mp in mas):\n                sb_gap = percent(max(ma(mp, 1) for mp in mas), c(1))\n                # 값사용시 반드시 기본 값인지 확인 할 것 기본값적용 해도 되는 조건인지 확인 필수\n                rise = maru = {'hc': 0, 'sb': 1, 'bars': 1, 'rise_rate': percent(c(), c(1)), 'three_rate': 0.0,\n                              'sb_gap': sb_gap, 'max_red': (0, body_pct()), 'max_blue': (None, 0.0), 'max_volumn': 0,\n                              'red_count': int(c() >= o()), 'blue_count': int(c() < o()), 'below': {mp: [] for mp in mas}}\n            else:\n                raise ValueError(f'마루 없음 - {\"첫봉 이평 이하\" if today_bars == 1 else \"이평 이하\"}')\n        \n        첫봉 = today_bars - 1\n        thcx = maru['hc']   # 최고 마루 봉 (당일 가장 높은 종가)\n        hcx = rise['hc']    # 최고종가봉 (가장 마지막 마루)\n        sbx = rise['sb']    # 상승 시작 봉 (최고종가의 시작점)\n        sb_gap = rise['sb_gap'] # SB 종가 대비 최고 이평값 갭(%)\n        bars = rise['bars'] # sb - hc 상승 구간 봉 개수\n        day_open_rate = percent(o(첫봉), dm.c(1)) # 당일 시가 갭 상승 여부 및 시작 % (상승 gap 이면 > 0)\n        rise_rate = rise['rise_rate']\n        three_rate = rise['three_rate']\n        max_v = rise['max_volumn']\n        hc_rate = percent(c(hcx), c(hcx + 1))\n    except Exception as e:\n        echo(f'△ {code} {name} 현재가={c()} / {e}')\n        ret(False)\n\n    if not msg:        \n        if 첫봉 == 0: # 현재 첫봉\n            if rise_rate > 2:\n                # 1분봉 현재봉 체결시간 분 = 첫 1분봉 인덱스 (09:00->0, 09:01->1, 09:02->2)\n                bar_idx = int(m1.bar_time()[2:4])\n                \n                if bar_idx == 0:  # 첫 1분 (09:00:00~09:00:59)\n                    msg = f'당일 첫봉 1 분간 매수 하지 않음'\n                elif m1.o(bar_idx) >= m1.c(bar_idx):  # 첫 1분봉이 음봉\n                    msg = f'당일 첫 1분봉 음봉시 매수 안 함'\n        else:\n            if hcx == 1 and bars < 6:\n                rise_limit = lambda x: percent(c(), o(sbx-1)) > 3 * x\n                if rise_limit(bars):\n                    msg = f'상승 시작 후 {bars}봉 이내 {3 * bars}% 이상 상승 중'\n            elif 5 > hcx > 1 and c(hcx) < c() and max_v * 0.8 > v():\n                msg = f'최고종가 위에서 매수시 최고거래량의의 80% 이하이면 안함'\n            elif blue(첫봉) and body_pct(첫봉) > 2.0 and 첫봉 < 5 and bottom(첫봉) > c():\n                msg = f'당일 첫봉 몸통 이하면 매수 안함'\n            elif blue() and hcx < 4:\n                half_body = (c(hcx) + o(hcx)) / 2\n                if half_body > c():\n                    msg = f'음봉이면 최고종가봉 중간 이하에서 매수 안 함'\n            elif o() < hoga(c(1), -3):\n                msg = f'-3호가 이상 갭 하락 시작시 매수 금지'\n            elif ma(9) > o() and percent(h(thcx), o()) > 3.0:\n                msg = f'9이평 아래에서 시가가 최고마루봉의 고가 대비 -3.0% 이하이면 매수 금지'\n            elif sbx < 4 and sb_gap > 2.0:\n                msg = f'SB 종가 대비 최고이평값 갭 2.0% 이상이면 매수 금지'\n\n    if not msg and thcx > 0:\n        # 최고마루봉의 고가 위\n        if c() > h(thcx):\n            # 갭 상승 시작 추격매수 금지\n            if c() > hoga(c(1), 3) and blue():\n                msg = f'3호가 이상 갭 상승 시작 후 음봉 매수 금지'\n\n        # 최고마루봉의 고가 아래\n        elif h(thcx) > c():\n            # 최고마루봉 전봉의 위꼬리가 1% 이상이고 그 봉의 고가 갱신 못함\n            if up_tail_pct(thcx + 1) > 1.0 and h(thcx + 1) >= h(thcx):\n                msg = f'최고마루봉 전봉이 1% 이상 윗꼬리가 있고 그 고점 넘지 못한 최고마루봉 회피'\n\n            # 최고마루봉이 종가 기준 고가 폭이 저가 폭보다 크고 현재가가 최고마루봉 고가 아래이면 매수 안함\n            elif h(thcx) - c(thcx) > c(thcx) - l(thcx) and h(thcx) > c():\n                if v(thcx) * 0.8 > v():\n                    msg = f'하락 우세인 최고마루봉의 고점(거래량)을 넘지 못 함'\n\n            # 최고마루봉 윗꼬리가 1% 이상이고 전봉이 그 고점을 못 넘었고 몸통의 1.5배이상인 윗꼬리 발생\n            elif thcx > 1 and up_tail_pct(thcx) > 1.0 and h(thcx) >= h(1) and h(thcx) > c() and up_tail_pct(1) > body_pct(1) * 1.5:\n                msg = f'최고마루봉의 고가저항에 몸통의 1.5배인 윗 꼬리 발생'\n\n            elif up_tail_pct(thcx) > 2.5:\n                msg = f'최고마루봉의 윗꼬리 2.5% 이상 발생'\n\n            elif up_tail_pct() > 1.0 and blue():\n                msg = f'현재봉 윗꼬리 1.0% 이상 발생하고 음봉'\n\n# 일반매도 조건 찾기 #####\nif not msg:\n    msg = 거래량매도(logoff=True, today_bars=today_bars, rise=rise, maru=maru)\n\n# 매수 성공 - 매도 상태 클리어\nif msg == '':\n    clear_trade_state(code, 'sell')\n\necho(f'{\"▲\" if msg == \"\" else \"△\"} {code} {name} 현재가= {c()} / {msg} : HC={hcx} ({bars}/{today_bars})')\nret(msg == '')",
        "desc": "[일반매수]\n1. 일반매도 스크립트 조건에 해당하지 않고,"
    },
    "거래량매도": {
        "script": "#  스크립트명 : 거래량매도 v20250920.170415\n\n\"\"\"\n<키움 검색식에 구현해야 할 조건들>\n1. 적용할 조건 없음.\n\n<이 스크립트에서 구현 할 조건들>\n0. 매도전략과 OR로 연결\n1. 이하 Cursor AI가 코드 분석 후 작성 할 것 (Cursor AI는 여길 읽는 즉시 작성 또는 수정 할 것)\n\"\"\"\ndm = ChartManager(code, 'dy')\nm3 = ChartManager(code, 'mi', 3)\nlogoff = is_args('logoff', False)\n\n# 기본 값 접근자 별칭\no, h, l, c, v, ma = m3.o, m3.h, m3.l, m3.c, m3.v, m3.ma\nup_tail, up_tail_pct = m3.up_tail, m3.up_tail_pct\ndown_tail, down_tail_pct = m3.down_tail, m3.down_tail_pct\nbody, body_pct = m3.body, m3.body_pct\nlength, length_pct = m3.length, m3.length_pct   \nbottom, top = m3.body_bottom, m3.body_top\nblue, red = m3.blue, m3.red\n\nbuy_idx = bar_idx(buy_dt)\n\nmas = [21, 15, 12, 6]\nmsg = ''\n\nm3._ensure_data_cache()\nwith m3.suspend_ensure():\n    \n    profit_pct = percent(c(), price) - 0.85 if price else 0\n\n    rise = is_args('rise', False)\n    if rise:\n        today_bars = is_args('today_bars', 0)\n        maru = is_args('maru', False)\n    else:\n        today_bars, rise, maru = m3.get_rising_state(mas, 0)\n    \n    try:\n        # 빈 딕셔너리 처리 (확정 봉 없음)\n        if not rise or not maru:\n            if today_bars == 1:\n                sb_gap = percent(max(ma(mp, 1) for mp in mas), c(1))\n                # 값사용시 반드시 기본 값인지 확인 할 것 기본값적용 해도 되는 조건인지 확인 필수\n                rise = maru = {'hc': 0, 'sb': 1, 'bars': 1, 'rise_rate': percent(c(), c(1)), 'three_rate': 0.0,\n                              'sb_gap': sb_gap, 'max_red': (0, body_pct()), 'max_blue': (None, 0.0), 'max_volumn': 0,\n                              'red_count': int(c() >= o()), 'blue_count': int(c() < o()), 'below': {mp: [] for mp in mas}}\n            else:\n                raise ValueError('마루 없음 - 이평 이하')\n        \n        첫봉 = today_bars - 1\n        bars = rise['bars'] # sb - hc 상승 구간 봉 개수\n        thcx = maru['hc']   # 최고 마루 봉 (당일 가장 높은 종가)\n        hcx = rise['hc']    # 최고종가봉 (가장 마지막 마루)\n        sbx = rise['sb']    # 상승 시작 봉 (최고종가의 시작점)\n        sb_gap = rise['sb_gap'] # SB 종가 대비 최고 이평값 갭(%)\n        day_open_rate = percent(o(첫봉), dm.c(1)) # 당일 시가 갭 상승 여부 및 시작 % (상승 gap 이면 > 0)\n        rise_rate = rise['rise_rate']\n        three_rate = rise['three_rate']\n        max_v = rise['max_volumn']\n        hc_rate = percent(c(hcx), c(hcx + 1)) # 최고종가봉 전봉 대비 상승률\n        size = max(rise['max_red'][1], rise['max_blue'][1])\n    except Exception as e:\n        msg = str(e)\n        ret(msg if logoff else False)\n\n    drop_pct = lambda x: max(percent(h(x+1) - c(x), c(x)), percent(h(x) - c(x), c(x)))\n    rebuy = lambda x: c() > h(1) > o(1) > ma(x, 1)# 매수시 매도조건에 걸려 매수 못 하는 문제 해소 즉 현재봉이 다시 상승인데 전봉이 매도조건에 걸리면 매수 못 함\n    gijun = lambda x: 0.25 * x < rise_rate - 1.5\n\n    # 현재봉: 현재봉을 기준으로 판단시 매수와 매도를 같은 봉에서 반복하지 않도록 유념할 것 ***********\n    if hoga(dm.c(1), 99) <= dm.c(0):\n        msg = f'상한가'\n    elif l(첫봉) > c() and ma(6) > c():\n        msg = f'당일 첫봉의 저점 및 6 이평을 이탈'\n    elif h(sbx) > c() and price > c(): \n        msg = f'상승 시작 봉 고가 ({h(sbx):,}) 이하 하락 매도'\n    elif hcx == 2 and hc_rate > 3 and drop_pct(0) > hc_rate:\n        msg = f'3%이상인 기준봉 이하로 하락'\n    elif buy_idx == 1 and price < o(buy_idx) and l(buy_idx) < ma(3, buy_idx) and blue(buy_idx) and l(buy_idx) > c():\n        msg = f'매수봉 종가가 3이평 이하의 음봉이고 재차 음봉으로 매수봉 저점 이탈'\n    elif up_tail_pct() > 3.0:\n        if c() < m3.bollinger_bands(20, 2)[0]:\n            msg = f'현재봉 윗꼬리 3% 이상 발생으로 볼밴상단 이탈'\n    elif up_tail_pct() > 2.5:\n        if body() < up_tail() and c() < m3.bollinger_bands(20, 2)[0]:\n            msg = f'현재봉 몸통보다 긴 2.5% 이상 윗꼬리 발생으로 볼밴상단 이탈'\n    elif hoga(c(1), -3) >= o():\n        if blue():\n            msg = f'3호가 이상 갭하락 음봉 매도'\n    elif hoga(c(1), 3) < o():\n        if c() < h() - hoga(h(), -3) and red():\n            msg = f'3호가 이상 갭 상승 시작 후 상승 중 3호가 이상 윗꼬리 발생'\n\n    # 현재봉으로 판단할지 더 고민 할 사항\n    elif hc_rate >= 6: \n        if hcx > 0 and c(hcx) < c() and up_tail_pct() > 2.0:\n            msg = f'최고종가봉 6% 이상 ({hc_rate:.2f}%) 상승후후 윗꼬리 2% 이상 발생 매도'\n        elif hcx < 3 and c(hcx) - body(hcx) / 4 > c():\n            msg = f'최고종가봉 6% 이상 ({hc_rate:.2f}%) 상승후 몸통의 1/4 이하로 하락 매도'\n\n    # 이전봉 : 이전봉으로 판단 ***********************************************************************\n    if not msg:\n        if bars > 2:\n            thresholds = [(1.0, 1.0), (1.5, 1.5), (2.0, 2.0), (2.5, 2.5)]\n            for size_limit, pct_limit in thresholds:\n                if size < size_limit:\n                    if drop_pct(1) > pct_limit:\n                        msg = f'{pct_limit}% 이내 완만한 상승중 2봉 {pct_limit}% 이상 급락 매도'\n                    elif up_tail_pct(1) > pct_limit:\n                        msg = f'{pct_limit}% 이내 완만한 상승중 윗꼬리 {pct_limit}% 이상 발생 매도'\n                    break\n\n    if not msg: \n        # 이평 이탈 후 조건 검사\n        if not rebuy(21) and ma(21, 1) > c(1):\n            if blue(1):\n                msg = f'20이평 이탈 매도' # size < 1.0 인경우도 매도 함\n        elif not rebuy(18) and ma(18, 1) > c(1):\n            if size < 1.0 and gijun(18): pass # 5.25%\n            elif blue(1): msg = f'18 이평 이탈 매도' # size >= 1.5 \n        elif not rebuy(15) and ma(15, 1) > c(1):\n            if size < 1.5 and gijun(15): pass # 5.25%\n            elif blue(1): msg = f'15 이평 이탈 매도' # size >= 1.5 \n        elif not rebuy(12) and ma(12, 1) > c(1):\n            if size < 1.8 and gijun(12): pass # 4.0%\n            elif blue(1): msg = f'12 이평 이탈 매도' # size >= 1.8 \n        elif not rebuy(9) and ma(9, 1) > c(1):\n            if size < 2.2 and gijun(9): pass # 4.25%\n            elif profit_pct >= 3:msg = f'이익 3% 이상 ({profit_pct:.2f}%) 9이평 이탈 매도'\n            elif hc_rate >= 3: msg = f'최고종가봉 3% 이상 ({hc_rate:.2f}%) 9이평 이탈 매도'\n            elif three_rate >= 5: msg = f'3봉 상승 5% 이상 ({three_rate:.2f}%) 9이평 이탈 매도'\n            elif rise_rate >= 7: msg = f'상승 시작 후 7% 이상 ({rise_rate:.2f}%) 9이평 이탈 매도'\n            elif blue(1): msg = f'9 이평 이탈 매도' # size >= 2.0 \n            # 추가 조건 검사 필요 함   \n        elif not rebuy(6) and ma(6, 1) > c(1):\n            if size < 2.2: pass\n            elif profit_pct >= 5: msg = f'이익 5% 이상 ({profit_pct:.2f}%) 6이평 이탈 매도'\n            elif hc_rate >= 4: msg = f'최고종가봉 4% 이상 ({hc_rate:.2f}%) 6이평 이탈 매도'\n            elif three_rate >= 6: msg = f'3봉 상승 6% 이상 ({three_rate:.2f}%) 6이평 이탈 매도'\n            elif rise_rate >= 10: msg = f'상승 시작 후 10% 이상 ({rise_rate:.2f}%) 6이평 이탈 매도'\n            # 추가 조건 검사 필요 함    \n        elif not rebuy(3) and ma(3, 1) > c(1):\n            if size < 2.2: pass\n            elif profit_pct >= 8: msg = f'이익 8% 이상 ({profit_pct:.2f}%) 3이평 이탈 매도'\n            elif 첫봉 > 0:\n                if hc_rate >= 5: msg = f'최고종가봉 5% 이상 ({hc_rate:.2f}%) 3이평 이탈 매도'\n                elif three_rate >= 8: msg = f'3봉 상승 8% 이상 ({three_rate:.2f}%) 3이평 이탈 매도'\n                elif rise_rate >= 15: msg = f'상승 시작 후 15% 이상 ({rise_rate:.2f}%) 3이평 이탈 매도'\n            # 추가 조건 검사 필요 함\n\n        else: # 이평 이탈 전 조건 검사\n            if up_tail_pct(2) >= 1.5:\n                up = up_tail(2)\n                if c(2) > c(1) and (o(2) == c(2) or (up >= body(2) * 3 and up * 0.2 > down_tail(2))):\n                    msg = f'전전봉 윗꼬리 1.5% 이상 몸통의 3배 유성형 양봉' # 윗꼬리는 밑꼬리의 5배 이상\n                elif up_tail_pct(1) > 1.5 and blue(1) and c(2) > c(1):\n                    msg = f'전전봉과 전봉 윗꼬리 1.5% 이상 발생하고 전봉 음봉'\n            elif up_tail_pct(1) >= 2.0:\n                if o(1) == c(1) or up_tail(1) > body(1) * 3:\n                    msg = f'전봉 윗꼬리 2%이상 유성형 패턴으로 급락'\n            elif up_tail_pct(hcx) > 1.5 and up_tail_pct(1) > 1.5 and h(hcx) > h(1) and c(hcx) > c(1): \n                msg = f'최고종가봉 고가 갱신 불발후 윗꼬리 1.5% 이상 발생 하락'\n            elif body_pct(2) > 1:\n                if top(2) > top(1) and bottom(2) < bottom(1) and length_pct(1) < 1.0:\n                    msg = f'전봉 하락 잉태형 패턴'\n                elif c(2) >= o(2):\n                    if top(2) <= top(1) and bottom(2) > bottom(1):\n                        msg = f'전봉 하락 장악형 패턴'\n            elif h(2) > h(1) and top(2) <= bottom(1):\n                if up_tail(1) > down_tail(1):\n                    msg = f'전봉 고가 갱신 불발후 위꼬리 내부에서 마감'\n            elif hcx > 2:\n                if h(hcx) > h(1) and bottom(1) >= top(hcx):\n                    msg = f'전봉 최고종가봉 고가 갱신 불발후 위꼬리 내부에서 마감'\n                elif (c(hcx) >= o(hcx)) and body_pct(hcx) > 1:\n                    if top(hcx) <= top(1) and bottom(hcx) > bottom(1):\n                        msg = f'전봉 최고종가 하락 장악형 패턴'\n            elif hcx == 2 and blue(1):\n                if m3.in_up_tail(price=h(1), n=hcx) and hoga(c(2), -1) > o(1): # 한호가 보다 큰 갭 하락\n                    msg = f'갭 하락 약세(강세) 출발 고가 갱신 불발 음봉 발생'\n                elif c(1) < ma(3, 1) and c(2) > o(1):\n                    msg = f'갭 하락 약세 출발 3이평 이탈 음봉 발생'\n                    \nif logoff: ret(msg)\nif msg:\n    # 매도 상태 저장 (같은 봉에서 재매수 방지)\n    set_trade_state(code, 'sell', {\n        'bar_time': m3.bar_time(),\n        'sell_price': m3.c(),\n        'reason': msg\n    })\n    \n    echo(f'▼ {code} {name}: {msg}')\n    echo(f'▽ {code} {name} 현재가: {dm.c():,} 손익률: {profit_pct:.2f}% ({price:,}원, {buy_idx}봉전 {buy_dt[:8]}_{buy_dt[8:14]} 매수)')\nret(msg != '')",
        "desc": "[일반매도]\n1. 상한가 이거나,\n2. 기준봉 기준가 이하이거나,\n3. 현재봉 기준 3분봉 5이평이 하락전환 하거나,\n4. 현재봉 기준 3분봉 5이평이 10이평 이하 이거나,\n5. 현재가가 10이평 이하 이거나,\n6. 전봉이 유성형 캔들이거나,\n7. 현재봉이 긴 윗꼬리달고 최고종가 이하로 하락시 매도"
    }
}